<!DOCTYPE html>
<html>

<head>
  <title>Bağlantılar</title>
  <link rel="stylesheet" href="favorites/bower_components/webix/codebase/skins/compact.css" type="text/css" charset="utf-8">
  <script src="favorites/bower_components/webix/codebase/webix.js" type="text/javascript" charset="utf-8"></script>


</head>

<body>

  <style>
    .highlight {
      background-color: #FFAAAA;
    }
  </style>

  <script type="text/javascript" charset="utf-8">
    var user = {}
    webix.ajax().get("/user", function (t, d, x) {
      user = d.json()
    })
    //named css
    function mark_old(value) {
      if (value < 1)
        return "highlight";
    }

    function date_string() {
      var today = new Date()
      var year = today.getFullYear()
      var monthNumber = Number(today.getMonth()) + 1
      var month = ""
      if (monthNumber < 10) { month = "0" + String(monthNumber) }
      else { month = String(monthNumber) }
      var dayNumber = today.getDate()
      var day = ""
      if (dayNumber < 10) { day = "0" + String(dayNumber) }
      else { day = String(dayNumber) }
      return year + "-" + month + "-" + day
    }

    function linkClick() {
      var id = $$("links").getSelectedId()
      $$("links").getItem(id)["lastvisit"] = date_string()
      $$("links").updateItem(id, $$("links").getItem(id))
      open($$("links").getItem(id)["url"])
      return true
    }

    function add_row() {
      var id = $$("links").add({
        "class": $$("links").getHeaderContent("classHead").getValue(),
        "category": $$("links").getHeaderContent("categoryHead").getValue(),
        // title: d.json().title.trim(),
        // meta: d.json().meta,
        "url": $$("links").getHeaderContent("urlHead").getValue(),
        "period": $$("links").getHeaderContent("periodHead").getValue(),
        "lastvisit": date_string(),
      });
      // webix.ajax().get("/favorites/api?url=" + $$("links").getHeaderContent("urlHead").getValue(), function (t, d, x) {
      //   console.log(d.json())
      // })
      $$("links").filter()
      $$("links").moveTop(id);
      $$("links").select(id)
      setTimeout(function () {
        $$("links").getHeaderContent("classHead").setValue("")
        $$("links").getHeaderContent("categoryHead").setValue("")
        $$("links").getHeaderContent("urlHead").setValue("")
        $$("links").getHeaderContent("periodHead").setValue("")
      }, 1000)
      // webix.ajax().headers({ "Authorization": "Bearer " + user.token }).get("/webscrap/api/title?url=" + $$("links").getHeaderContent("urlHead").getValue(), function (t, d, x) {
      // })
    }
    function delete_row() {
      $$("links").remove($$("links").getSelectedId(true));
    }

    iconTemplate = function (obj) {
      return "<img height=20 src='https://www.google.com/s2/favicons?domain=" + obj.url + "'>"
    }

    pastvisTemplate = function (obj) {
      var lastvisit = new Date(obj.lastvisit)
      var today = new Date()
      return obj.period - ((today.getTime() - lastvisit.getTime()) / 86400000).toFixed(0)
    }

    function pastvisSort(a, b) {
      var lastvisit_a = new Date(a.lastvisit)
      var lastvisit_b = new Date(b.lastvisit)
      var today = new Date()
      var pastvis_a = a.period - ((today.getTime() - lastvisit_a.getTime()) / 86400000).toFixed(0)
      var pastvis_b = b.period - ((today.getTime() - lastvisit_b.getTime()) / 86400000).toFixed(0)
      return pastvis_a > pastvis_b ? 1 : -1
    }

    webix.ready(function () {

      var grid = {
        id: "links",
        url: "/favorites/api",
        save: "rest->/favorites/api",
        view: "datatable", select: "row",
        columns: [
          { id: "favicon", header: "", width: 50, template: iconTemplate },
          { id: "class", header: ["Class", { content: "selectFilter", contentId: "classHead"/*, options: classOptions*/ }], editor: "text", sort: "text", fillspace: 3 },
          { id: "category", header: ["Category", { content: "textFilter", contentId: "categoryHead"/*, options: categoryOptions*/ }], editor: "text", fillspace: 4 },
          { id: "title", header: ["Title", { content: "textFilter", contentId: "titleHead" }], editor: "text", fillspace: 11 },
          { id: "url", header: ["URL", { content: "textFilter", contentId: "urlHead" }], template: "<a href='javascript:linkClick()'>#url#</a>", editor: "text", fillspace: 11 },
          { id: "period", header: ["Period", { content: "selectFilter", contentId: "periodHead" }], width: 75, editor: "select", options: ["360", "180", "90", "60", "30", "15", "7", "3"], fillspace: 2 },
          { id: "lastvisit", header: "Last Vis", editor: "text", fillspace: 4 },
          { id: "pastvis", header: "Countdown", sort: "int", cssFormat: mark_old, template: pastvisTemplate, fillspace: 2 },
          { id: "delete_row", header: "<input type='button' value='Ekle' onclick='add_row()'/>", template: "<input type='button' value='Sil' onclick='delete_row()'/>", fillspace: 2 }
        ],
        editable: true, editaction: "dblclick",
        on: {
          "onAfterLoad": function () {
            setTimeout(function () { $$("links").sort(pastvisSort, "asc") }, 2000)
          },
          "onSelectChange": function () {
            var item = this.getSelectedItem()
            webix.ajax().headers({ "Authorization": "Bearer " + user.token }).get("/webscrap/api/title?url=" + item.url, function (t, d, x) {
              item.title = d.json().title.trim()
              item.meta = d.json().meta
              $$("links").updateItem(item.id, item)
            })
          }
        }
      }

      app = webix.ui({
        rows: [grid]
      });
    });



  </script>


</body>

</html>